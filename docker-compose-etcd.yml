version: '3.4'
services:
  bitcoind:
    image: kylemanna/bitcoind
    volumes:
      - ./bitcoin.conf:/bitcoin/.bitcoin/bitcoin.conf

  etcd-alice:
    restart: unless-stopped
    image: 'bitnami/etcd:3.5.0'
    environment:
      - ALLOW_NONE_AUTHENTICATION=yes
      - ETCD_LISTEN_CLIENT_URLS=http://0.0.0.0:2379
      - ETCD_ADVERTISE_CLIENT_URLS=http://0.0.0.0:2379
      - ETCD_MAX_TXN_OPS=16384
      - ETCD_MAX_REQUEST_BYTES=104857600
      - ETCD_LOG_LEVEL=error
      - ETCD_AUTO_COMPACTION_MODE=revision
      - ETCD_AUTO_COMPACTION_RETENTION=1000

  etcd-bob:
    restart: unless-stopped
    image: 'bitnami/etcd:3.5.0'
    environment:
      - ALLOW_NONE_AUTHENTICATION=yes
      - ETCD_LISTEN_CLIENT_URLS=http://0.0.0.0:2379
      - ETCD_ADVERTISE_CLIENT_URLS=http://0.0.0.0:2379
      - ETCD_MAX_TXN_OPS=16384
      - ETCD_MAX_REQUEST_BYTES=104857600
      - ETCD_LOG_LEVEL=error
      - ETCD_AUTO_COMPACTION_MODE=revision
      - ETCD_AUTO_COMPACTION_RETENTION=1000

  etcd-charlie:
    restart: unless-stopped
    image: 'bitnami/etcd:3.5.0'
    environment:
      - ALLOW_NONE_AUTHENTICATION=yes
      - ETCD_LISTEN_CLIENT_URLS=http://0.0.0.0:2379
      - ETCD_ADVERTISE_CLIENT_URLS=http://0.0.0.0:2379
      - ETCD_MAX_TXN_OPS=16384
      - ETCD_MAX_REQUEST_BYTES=104857600
      - ETCD_LOG_LEVEL=error
      - ETCD_AUTO_COMPACTION_MODE=revision
      - ETCD_AUTO_COMPACTION_RETENTION=1000

  lnd-alice:
    restart: unless-stopped
    build: 
      context: lnd
      args:
        repo: https://github.com/guggero/lnd
        checkout: b873ab8bdefe958ff6b09b3b0783394300a0955c
        tags: signrpc walletrpc chainrpc invoicesrpc monitoring kvdb_etcd
    depends_on:
      - bitcoind
      - etcd-alice
    volumes:
      - ./lnd.conf:/root/.lnd/lnd.conf
      - lnd-alice:/cfg
    ports:
      - 5000:5000      
    command: --tlsextradomain=lnd-alice --db.backend=etcd --db.etcd.host=etcd-alice:2379 --db.etcd.disabletls --protocol.no-anchors 

  lnd-bob:
    restart: unless-stopped
    build: 
      context: lnd
      args:
        repo: https://github.com/guggero/lnd
        checkout: b873ab8bdefe958ff6b09b3b0783394300a0955c
        tags: signrpc walletrpc chainrpc invoicesrpc monitoring kvdb_etcd
    depends_on:
      - bitcoind
      - etcd-bob
    volumes:
      - ./lnd.conf:/root/.lnd/lnd.conf
      - lnd-bob:/cfg
    ports:
      - 5001:5000      
    command: --tlsextradomain=lnd-bob --db.backend=etcd --db.etcd.host=etcd-bob:2379 --db.etcd.disabletls --protocol.no-anchors 

  lnd-charlie:
    restart: unless-stopped
    build: 
      context: lnd
      args:
        repo: https://github.com/guggero/lnd
        checkout: b873ab8bdefe958ff6b09b3b0783394300a0955c
        tags: signrpc walletrpc chainrpc invoicesrpc monitoring kvdb_etcd
    depends_on:
      - bitcoind
      - etcd-charlie
    volumes:
      - ./lnd.conf:/root/.lnd/lnd.conf
      - lnd-charlie:/cfg
    ports:
      - 5002:5000      
    command: --tlsextradomain=lnd-charlie --db.backend=etcd --db.etcd.host=etcd-charlie:2379 --db.etcd.disabletls --protocol.no-anchors 

  loadtest:
    build: loadtest
    depends_on:
      - lnd-alice
      - lnd-bob
      - lnd-charlie
    volumes:
      - lnd-alice:/lnd-alice
      - lnd-bob:/lnd-bob
      - lnd-charlie:/lnd-charlie
      - ./${LOADTEST_CONFIG_FILE}:/loadtest.yml
 
volumes:
  lnd-alice:
  lnd-bob:
  lnd-charlie:
    